"""
Nadiren kullanƒ±lan √∂ƒüelerin (men≈üe √ºlke, √∂deme ≈üekli) analizi mod√ºl√º.
Firmalarƒ±n alƒ±≈üƒ±lmƒ±≈üƒ±n dƒ±≈üƒ±nda kullandƒ±klarƒ± men≈üe √ºlke ve √∂deme ≈üekillerini tespit eder.
"""

import pandas as pd

def _create_rarely_used_html_report(result_data, item_type, firma_column):
    """
    Nadiren kullanƒ±lan √∂ƒüelerin (d√∂viz, men≈üe √ºlke, √∂deme ≈üekli) geli≈ümi≈ü HTML raporunu olu≈üturur
    
    Args:
        result_data (list): Analiz sonu√ßlarƒ± listesi
        item_type (str): √ñƒüe tipi ("d√∂viz", "men≈üe √ºlke", "√∂deme ≈üekli")
        firma_column (str): Firma s√ºtun adƒ±
        
    Returns:
        str: HTML rapor i√ßeriƒüi
    """
    if not result_data:
        return f"""
        <div style="padding: 20px; text-align: center;">
            <h3>Nadiren kullanƒ±lan {item_type} bulunamadƒ±.</h3>
            <p>T√ºm firmalar tutarlƒ± {item_type} kullanƒ±mƒ± g√∂stermektedir.</p>
        </div>
        """
    
    # CSS stilleri
    html = f"""
    <html>
    <head>
        <meta charset="UTF-8">
        <style>
            body {{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f8f9fa;
                color: #333;
                line-height: 1.6;
            }}
            .container {{
                max-width: 1400px;
                margin: 0 auto;
                background-color: white;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }}
            .header {{
                background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }}
            .header h1 {{
                margin: 0;
                font-size: 28px;
                font-weight: 300;
            }}
            .header p {{
                margin: 10px 0 0 0;
                opacity: 0.9;
            }}
            .content {{
                padding: 30px;
            }}
            .summary-box {{
                background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
                border: 1px solid #ffc107;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 25px;
                border-left: 5px solid #ffc107;
            }}
            .summary-title {{
                font-size: 18px;
                font-weight: bold;
                color: #856404;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
            }}
            .summary-title::before {{
                content: "üîç";
                margin-right: 10px;
                font-size: 20px;
            }}
            .stats-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin: 25px 0;
            }}
            .stat-card {{
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                color: white;
                border-radius: 10px;
                padding: 20px;
                text-align: center;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }}
            .stat-number {{
                font-size: 36px;
                font-weight: bold;
                margin-bottom: 5px;
            }}
            .stat-label {{
                font-size: 14px;
                opacity: 0.9;
            }}
            .firm-section {{
                margin: 30px 0;
                padding: 25px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 10px;
                border-left: 5px solid #fd79a8;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }}
            .firm-header {{
                background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                margin: -25px -25px 20px -25px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }}
            .firm-name {{
                font-size: 18px;
                font-weight: 600;
            }}
            .firm-badge {{
                background-color: rgba(255,255,255,0.2);
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: bold;
            }}
            .info-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin: 20px 0;
            }}
            .info-card {{
                background-color: white;
                padding: 15px;
                border-radius: 8px;
                border: 1px solid #dee2e6;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }}
            .info-card h4 {{
                color: #495057;
                margin: 0 0 10px 0;
                font-size: 14px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }}
            .info-value {{
                font-size: 18px;
                font-weight: bold;
                color: #343a40;
            }}
            .percentage {{
                color: #fd79a8;
                font-weight: bold;
            }}
            .percentage.low {{
                color: #dc3545;
            }}
            table {{
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                background-color: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }}
            th {{
                background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
                color: white;
                text-align: left;
                padding: 15px;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 12px;
                letter-spacing: 0.5px;
            }}
            td {{
                padding: 12px 15px;
                border-bottom: 1px solid #f0f0f0;
            }}
            tr:nth-child(even) {{
                background-color: #f8f9fa;
            }}
            tr:hover {{
                background-color: #fdf2f8;
                transition: background-color 0.3s ease;
            }}
            .badge {{
                display: inline-block;
                padding: 4px 8px;
                background-color: #fdf2f8;
                color: #be185d;
                border-radius: 4px;
                font-size: 11px;
                font-weight: bold;
                margin: 1px;
            }}
            .badge.rare {{
                background-color: #ffebee;
                color: #c62828;
            }}
            .evaluation-box {{
                background: linear-gradient(135deg, #fdf2f8 0%, #fcf1f2 100%);
                border: 1px solid #f8bbd9;
                border-radius: 8px;
                padding: 25px;
                margin-top: 30px;
                border-left: 5px solid #fd79a8;
            }}
            .evaluation-title {{
                color: #be185d;
                font-size: 20px;
                font-weight: bold;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
            }}
            .evaluation-title::before {{
                content: "üí°";
                margin-right: 10px;
                font-size: 22px;
            }}
            ul {{
                padding-left: 20px;
            }}
            li {{
                margin: 8px 0;
                color: #424242;
            }}
            .beyanname-list {{
                max-height: 100px;
                overflow-y: auto;
                padding: 8px;
                background-color: #f8f9fa;
                border-radius: 4px;
                border: 1px solid #dee2e6;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Nadiren Kullanƒ±lan {item_type.title()} Analizi</h1>
                <p>T√ºrk√ße Mod√ºl - Firma Bazlƒ± {item_type.title()} Kullanƒ±m Tutarsƒ±zlƒ±k Raporu</p>
            </div>
            
            <div class="content">
                <div class="summary-box">
                    <div class="summary-title">Analiz √ñzeti</div>
                    <p>Bu rapor, firmalarƒ±n genelde tercih ettiƒüi <strong>{item_type}</strong> se√ßimlerinden farklƒ± olarak nadiren kullandƒ±klarƒ± <strong>{item_type}</strong> √∂ƒüelerini g√∂sterir.</p>
                    <p>Toplam <strong>{len(result_data)}</strong> firmada nadiren kullanƒ±lan {item_type} tespit edilmi≈ütir.</p>
                </div>
    """
    
    # ƒ∞statistik kartlarƒ±
    total_firms = len(result_data)
    total_rare_items = sum([len(item.get('nadir_kullanilan_dovizler', []) or 
                                item.get('nadir_kullanilan_ulkeler', []) or 
                                item.get('nadir_kullanilan_odeme_sekilleri', [])) for item in result_data])
    
    avg_rare_per_firm = round(total_rare_items / total_firms, 1) if total_firms > 0 else 0
    
    html += f"""
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">{total_firms}</div>
                        <div class="stat-label">Etkilenen Firma</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{total_rare_items}</div>
                        <div class="stat-label">Toplam Nadir {item_type.title()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{avg_rare_per_firm}</div>
                        <div class="stat-label">Firma Ba≈üƒ±na Ortalama</div>
                    </div>
                </div>
    """
    
    # Her firma i√ßin ayrƒ± b√∂l√ºm olu≈ütur
    for i, item in enumerate(result_data):
        firma = item['firma']
        
        # Dinamik alan adlarƒ±
        if 'en_cok_kullanilan_doviz' in item:
            en_cok_kullanilan = item['en_cok_kullanilan_doviz']
            en_cok_yuzde = round(item['en_cok_kullanilan_doviz_yuzdesi'], 2)
            nadir_kullanilan_list = item['nadir_kullanilan_dovizler']
            nadir_field_name = 'doviz'
        elif 'en_cok_kullanilan_ulke' in item:
            en_cok_kullanilan = item['en_cok_kullanilan_ulke']
            en_cok_yuzde = round(item['en_cok_kullanilan_ulke_yuzdesi'], 2)
            nadir_kullanilan_list = item['nadir_kullanilan_ulkeler']
            nadir_field_name = 'ulke'
        else:
            en_cok_kullanilan = item['en_cok_kullanilan_odeme']
            en_cok_yuzde = round(item['en_cok_kullanilan_odeme_yuzdesi'], 2)
            nadir_kullanilan_list = item['nadir_kullanilan_odeme_sekilleri']
            nadir_field_name = 'odeme'
        
        html += f"""
                <div class="firm-section">
                    <div class="firm-header">
                        <div class="firm-name">üè¢ {firma}</div>
                        <div class="firm-badge">{len(nadir_kullanilan_list)} nadir {item_type}</div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>En √áok Kullanƒ±lan {item_type.title()}</h4>
                            <div class="info-value">{en_cok_kullanilan}</div>
                            <div class="percentage">%{en_cok_yuzde}</div>
                        </div>
                        <div class="info-card">
                            <h4>Nadir Kullanƒ±lan {item_type.title()} Sayƒ±sƒ±</h4>
                            <div class="info-value">{len(nadir_kullanilan_list)}</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Nadiren Kullanƒ±lan {item_type.title()}</th>
                                <th>Kullanƒ±m Sayƒ±sƒ±</th>
                                <th>Y√ºzde (%)</th>
                                <th>√ñrnek Beyannameler</th>
                            </tr>
                        </thead>
                        <tbody>
        """
        
        for nadir_item in nadir_kullanilan_list:
            deger = nadir_item[nadir_field_name]
            sayi = nadir_item['sayi']
            yuzde = round(nadir_item['yuzde'], 2)
            ornek_beyannameler = nadir_item.get('ornek_beyannameler', [])
            
            # Beyanname listesini daha g√ºzel g√∂ster
            if ornek_beyannameler:
                if len(ornek_beyannameler) <= 5:
                    beyanname_display = ", ".join(ornek_beyannameler)
                else:
                    beyanname_display = f"""
                    <div class="beyanname-list">
                        {", ".join(ornek_beyannameler[:5])}
                        {f" ve {len(ornek_beyannameler)-5} beyanname daha..." if len(ornek_beyannameler) > 5 else ""}
                    </div>
                    """
            else:
                beyanname_display = "-"
            
            percentage_class = "low" if yuzde < 5 else ""
            
            html += f"""
                    <tr>
                        <td><span class="badge rare">{deger}</span></td>
                        <td><strong>{sayi}</strong></td>
                        <td><span class="percentage {percentage_class}">{yuzde}%</span></td>
                        <td>{beyanname_display}</td>
                    </tr>
            """
        
        html += """
                        </tbody>
                    </table>
                </div>
        """
    
    # Deƒüerlendirme b√∂l√ºm√º
    html += f"""
                <div class="evaluation-box">
                    <div class="evaluation-title">Deƒüerlendirme ve √ñneriler</div>
                    <p>Firmalarƒ±n nadiren kullandƒ±ƒüƒ± <strong>{item_type}</strong> √∂ƒüeleri, a≈üaƒüƒ±daki sebeplerden kaynaklanabilir:</p>
                    <ul>
                        <li><strong>√ñzel Durumlar:</strong> Genellikle tercih edilen {item_type}den farklƒ± √∂zel bir durumun ge√ßici olarak ortaya √ßƒ±kmasƒ±</li>
                        <li><strong>Ekonomik Sebepler:</strong> Vergi avantajƒ± veya maliyet d√º≈ü√ºrme ama√ßlƒ± i≈ülemler</li>
                        <li><strong>D√∂nemsel Deƒüi≈üiklikler:</strong> Sadece belirli bir s√ºre veya belirli i≈ülemler i√ßin kullanƒ±lan farklƒ± {item_type}</li>
                        <li><strong>Operasyonel Hatalar:</strong> Veri giri≈üi hatalarƒ± veya tutarsƒ±z kodlamalar</li>
                        <li><strong>ƒ∞≈ü Stratejisi Deƒüi≈üiklikleri:</strong> Firmanƒ±n i≈ü modelindeki deƒüi≈üikliklere baƒülƒ± ge√ßici uygulamalar</li>
                    </ul>
                    <p><strong>Tavsiye:</strong> Bu tip tutarsƒ±zlƒ±klarƒ±n detaylƒ± incelenmesi, i≈ülemlerin tutarlƒ±lƒ±ƒüƒ± ve risk deƒüerlendirmesi a√ßƒ±sƒ±ndan √∂nemlidir. √ñzellikle d√º≈ü√ºk y√ºzdeli kullanƒ±mlar dikkatle g√∂zden ge√ßirilmelidir.</p>
                </div>
            </div>
        </div>
    </body>
    </html>
    """
    
    return html

def kontrol_nadir_kullanilan_mense_ulke(df):
    """
    Firmalara g√∂re nadiren kullanƒ±lan men≈üe √ºlkeleri kontrol eder
    
    Args:
        df (pandas.DataFrame): Beyanname verileri i√ßeren DataFrame
    
    Returns:
        dict: Analiz sonu√ßlarƒ±
    """
    if 'Mensei_ulke' not in df.columns:
        return {
            "status": "error",
            "message": "Men≈üe √ºlke bilgisi s√ºtunu bulunamadƒ±"
        }
    
    # Firma s√ºtunlarƒ±nƒ± belirle
    firma_columns = [
        'Adi_unvani', 'Gonderen', 'Gonderen_adi', 'Gonderen_firma', 
        'Ihracatci', 'Ithalatci', 'Satici', 'Alici'
    ]
    
    # Mevcut olan firma s√ºtununu bul
    firma_column = None
    for col in firma_columns:
        if col in df.columns:
            firma_column = col
            break
    
    if not firma_column:
        return {
            "status": "error",
            "message": "Firma/ithalat√ßƒ±/ihracat√ßƒ± s√ºtunu bulunamadƒ±"
        }
    
    # Bo≈ü firma ve men≈üe √ºlke deƒüerlerini filtrele
    filtered_df = df[(df[firma_column].notna()) & (df['Mensei_ulke'].notna())]
    filtered_df = filtered_df[(df[firma_column] != '') & (df['Mensei_ulke'] != '')]
    
    if len(filtered_df) == 0:
        return {
            "status": "error",
            "message": "Filtreleme sonrasƒ± incelenecek veri kalmadƒ±"
        }
    
    # Her firma i√ßin men≈üe √ºlke kullanƒ±mƒ±nƒ± hesapla
    result_data = []
    
    # Firmalarƒ± grupla
    for firma, firma_data in filtered_df.groupby(firma_column):
        # Bo≈ü veya ge√ßersiz firma adlarƒ±nƒ± atla
        if pd.isna(firma) or firma == '':
            continue
            
        # Men≈üe √ºlkeleri say
        ulke_counts = firma_data['Mensei_ulke'].value_counts()
        
        # En az 2 farklƒ± men≈üe √ºlke kullanan firmalarƒ± kontrol et
        if len(ulke_counts) >= 2:
            # Toplam beyanname sayƒ±sƒ±
            total_beyanname_count = len(firma_data['Beyanname_no'].unique())
            
            # En √ßok ve en az kullanƒ±lan men≈üe √ºlkeleri belirle
            most_common_country = ulke_counts.index[0]
            most_common_count = ulke_counts.iloc[0]
            most_common_percentage = (most_common_count / len(firma_data)) * 100
            
            # Nadiren kullanƒ±lan men≈üe √ºlkeleri bul
            threshold_percentage = 10  # %10'dan az kullanƒ±lanlar "nadir" olarak kabul edilecek
            rarely_used_countries = []
            
            for country, count in ulke_counts.items():
                if country == most_common_country:
                    continue
                    
                percentage = (count / len(firma_data)) * 100
                if percentage < threshold_percentage:
                    # Nadir kullanƒ±lan men≈üe √ºlke √∂rnek beyannamelerini bul
                    sample_beyannames = firma_data[firma_data['Mensei_ulke'] == country]['Beyanname_no'].unique()
                    sample_beyannames = sample_beyannames[:5].tolist()  # En fazla 5 √∂rnek
                    
                    rarely_used_countries.append({
                        'ulke': country,
                        'sayi': count,
                        'yuzde': percentage,
                        'ornek_beyannameler': sample_beyannames
                    })
            
            # Nadir kullanƒ±lan men≈üe √ºlke varsa sonuca ekle
            if rarely_used_countries:
                result_data.append({
                    'firma': firma,
                    'toplam_beyanname': total_beyanname_count,
                    'en_cok_kullanilan_ulke': most_common_country,
                    'en_cok_kullanilan_ulke_sayisi': most_common_count,
                    'en_cok_kullanilan_ulke_yuzdesi': most_common_percentage,
                    'nadir_kullanilan_ulkeler': rarely_used_countries
                })
    
    if not result_data:
        return {
            "status": "ok",
            "message": "Nadiren kullanƒ±lan men≈üe √ºlke tespit edilmedi"
        }
    
    # Sonu√ß dataframe'i olu≈ütur
    result_rows = []
    
    for item in result_data:
        firma = item['firma']
        
        for country_info in item['nadir_kullanilan_ulkeler']:
            country = country_info['ulke']
            count = country_info['sayi']
            percentage = country_info['yuzde']
            sample_beyannames = country_info['ornek_beyannameler']
            
            # √ñrnek beyannameleri ilgili veriyi al
            sample_data = filtered_df[
                (filtered_df[firma_column] == firma) & 
                (filtered_df['Mensei_ulke'] == country) &
                (filtered_df['Beyanname_no'].isin(sample_beyannames))
            ]
            
            for _, row in sample_data.iterrows():
                result_row = {
                    'Firma': firma,
                    'Nadiren_Kullanilan_Ulke': country,
                    'Kullanim_Sayisi': count,
                    'Kullanim_Yuzdesi': percentage,
                    'En_Cok_Kullanilan_Ulke': item['en_cok_kullanilan_ulke'],
                }
                
                # Beyannameye ili≈ükin detaylarƒ± ekle
                for col in ['Beyanname_no', 'Mensei_ulke', 'Fatura_miktari', 'Gtip', 'Rejim']:
                    if col in row:
                        result_row[col] = row[col]
                
                result_rows.append(result_row)
    
    # T√ºm sonu√ßlarƒ± i√ßeren DataFrame
    result_df = pd.DataFrame(result_rows)
    
    # √ñzet DataFrame'i
    summary_data = []
    for item in result_data:
        for country_info in item['nadir_kullanilan_ulkeler']:
            summary_data.append({
                'Firma': item['firma'],
                'En_Cok_Kullanilan_Ulke': item['en_cok_kullanilan_ulke'],
                'En_Cok_Kullanilan_Ulke_Yuzdesi': round(item['en_cok_kullanilan_ulke_yuzdesi'], 2),
                'Nadir_Kullanilan_Ulke': country_info['ulke'],
                'Nadir_Kullanilan_Ulke_Sayisi': country_info['sayi'],
                'Nadir_Kullanilan_Ulke_Yuzdesi': round(country_info['yuzde'], 2)
            })
    
    summary_df = pd.DataFrame(summary_data)
    
    # HTML rapor olu≈ütur
    html_report = _create_rarely_used_html_report(result_data, "men≈üe √ºlke", firma_column)
    
    return {
        "status": "warning" if len(result_data) > 0 else "ok",
        "message": f"{len(result_data)} firmada nadiren kullanƒ±lan men≈üe √ºlke tespit edildi" if result_data else "Nadiren kullanƒ±lan men≈üe √ºlke tespit edilmedi",
        "data": result_df,
        "summary": summary_df,
        "html_report": html_report
    }

def kontrol_nadir_kullanilan_odeme_sekli(df):
    """
    Firmalara g√∂re nadiren kullanƒ±lan √∂deme ≈üekillerini kontrol eder
    
    Args:
        df (pandas.DataFrame): Beyanname verileri i√ßeren DataFrame
    
    Returns:
        dict: Analiz sonu√ßlarƒ±
    """
    # √ñdeme s√ºtunu √∂ncelik sƒ±rasƒ±: Odeme_sekli, Odeme, Odeme_yontemi
    payment_columns = ['Odeme_sekli', 'Odeme', 'Odeme_yontemi']
    payment_column = None
    
    for col in payment_columns:
        if col in df.columns:
            payment_column = col
            break
    
    if not payment_column:
        return {
            "status": "error",
            "message": f"√ñdeme ≈üekli bilgisi s√ºtunu bulunamadƒ±. Aranan s√ºtunlar: {', '.join(payment_columns)}"
        }
    
    # Firma s√ºtunlarƒ±nƒ± belirle
    firma_columns = [
        'Adi_unvani', 'Gonderen', 'Gonderen_adi', 'Gonderen_firma', 
        'Ihracatci', 'Ithalatci', 'Satici', 'Alici'
    ]
    
    # Mevcut olan firma s√ºtununu bul
    firma_column = None
    for col in firma_columns:
        if col in df.columns:
            firma_column = col
            break
    
    if not firma_column:
        return {
            "status": "error",
            "message": "Firma/ithalat√ßƒ±/ihracat√ßƒ± s√ºtunu bulunamadƒ±"
        }
    
    # Bo≈ü firma ve √∂deme ≈üekli deƒüerlerini filtrele
    filtered_df = df[(df[firma_column].notna()) & (df[payment_column].notna())]
    filtered_df = filtered_df[(df[firma_column] != '') & (df[payment_column] != '')]
    
    if len(filtered_df) == 0:
        return {
            "status": "error",
            "message": "Filtreleme sonrasƒ± incelenecek veri kalmadƒ±"
        }
    
    # Her firma i√ßin √∂deme ≈üekli kullanƒ±mƒ±nƒ± hesapla
    result_data = []
    
    # Firmalarƒ± grupla
    for firma, firma_data in filtered_df.groupby(firma_column):
        # Bo≈ü veya ge√ßersiz firma adlarƒ±nƒ± atla
        if pd.isna(firma) or firma == '':
            continue
            
        # √ñdeme ≈üekillerini say
        odeme_counts = firma_data[payment_column].value_counts()
        
        # En az 2 farklƒ± √∂deme ≈üekli kullanan firmalarƒ± kontrol et
        if len(odeme_counts) >= 2:
            # Toplam beyanname sayƒ±sƒ±
            total_beyanname_count = len(firma_data['Beyanname_no'].unique())
            
            # En √ßok ve en az kullanƒ±lan √∂deme ≈üekillerini belirle
            most_common_payment = odeme_counts.index[0]
            most_common_count = odeme_counts.iloc[0]
            most_common_percentage = (most_common_count / len(firma_data)) * 100
            
            # Nadiren kullanƒ±lan √∂deme ≈üekillerini bul
            threshold_percentage = 10  # %10'dan az kullanƒ±lanlar "nadir" olarak kabul edilecek
            rarely_used_payments = []
            
            for payment, count in odeme_counts.items():
                if payment == most_common_payment:
                    continue
                    
                percentage = (count / len(firma_data)) * 100
                if percentage < threshold_percentage:
                    # Nadir kullanƒ±lan √∂deme ≈üekli √∂rnek beyannamelerini bul
                    sample_beyannames = firma_data[firma_data[payment_column] == payment]['Beyanname_no'].unique()
                    sample_beyannames = sample_beyannames[:5].tolist()  # En fazla 5 √∂rnek
                    
                    rarely_used_payments.append({
                        'odeme': payment,
                        'sayi': count,
                        'yuzde': percentage,
                        'ornek_beyannameler': sample_beyannames
                    })
            
            # √ñzel ilgi: "pe≈üin" veya "cash" i√ßeren √∂deme ≈üekilleri
            special_keywords = ["pe≈üin", "pesin", "cash", "advance", "nakit"]
            
            for payment, count in odeme_counts.items():
                if payment == most_common_payment:
                    continue
                
                payment_lower = payment.lower()
                is_special = any(keyword in payment_lower for keyword in special_keywords)
                percentage = (count / len(firma_data)) * 100
                
                # √ñzel anahtar kelime i√ßeren ve %20'nin altƒ±nda kullanƒ±lan √∂demeler
                if is_special and percentage < 20:
                    # Eƒüer bu √∂deme ≈üekli zaten nadir kullanƒ±lanlar listesinde yoksa ekle
                    if not any(item['odeme'] == payment for item in rarely_used_payments):
                        sample_beyannames = firma_data[firma_data[payment_column] == payment]['Beyanname_no'].unique()
                        sample_beyannames = sample_beyannames[:5].tolist()  # En fazla 5 √∂rnek
                        
                        rarely_used_payments.append({
                            'odeme': payment,
                            'sayi': count,
                            'yuzde': percentage,
                            'ornek_beyannameler': sample_beyannames,
                            'ozel': True  # √ñzel ilgi gerektiren bir √∂deme ≈üekli
                        })
            
            # Nadir kullanƒ±lan √∂deme ≈üekli varsa sonuca ekle
            if rarely_used_payments:
                result_data.append({
                    'firma': firma,
                    'toplam_beyanname': total_beyanname_count,
                    'en_cok_kullanilan_odeme': most_common_payment,
                    'en_cok_kullanilan_odeme_yuzdesi': most_common_percentage,
                    'nadir_kullanilan_odeme_sekilleri': rarely_used_payments
                })
    
    if not result_data:
        return {
            "status": "ok",
            "message": "Nadiren kullanƒ±lan √∂deme ≈üekli tespit edilmedi"
        }
    
    # Sonu√ß dataframe'i olu≈ütur
    result_rows = []
    
    for item in result_data:
        firma = item['firma']
        
        for payment_info in item['nadir_kullanilan_odeme_sekilleri']:
            payment = payment_info['odeme']
            count = payment_info['sayi']
            percentage = payment_info['yuzde']
            sample_beyannames = payment_info['ornek_beyannameler']
            is_special = payment_info.get('ozel', False)
            
            # √ñrnek beyannameleri ilgili veriyi al
            sample_data = filtered_df[
                (filtered_df[firma_column] == firma) & 
                (filtered_df[payment_column] == payment) &
                (filtered_df['Beyanname_no'].isin(sample_beyannames))
            ]
            
            for _, row in sample_data.iterrows():
                result_row = {
                    'Firma': firma,
                    'Nadiren_Kullanilan_Odeme': payment,
                    'Kullanim_Sayisi': count,
                    'Kullanim_Yuzdesi': percentage,
                    'En_Cok_Kullanilan_Odeme': item['en_cok_kullanilan_odeme'],
                    'Ozel_Ilgi': is_special
                }
                
                # Beyannameye ili≈ükin detaylarƒ± ekle
                for col in ['Beyanname_no', payment_column, 'Fatura_miktari', 'Gtip', 'Rejim']:
                    if col in row:
                        result_row[col] = row[col]
                
                result_rows.append(result_row)
    
    # T√ºm sonu√ßlarƒ± i√ßeren DataFrame
    result_df = pd.DataFrame(result_rows)
    
    # √ñzet DataFrame'i
    summary_data = []
    for item in result_data:
        for payment_info in item['nadir_kullanilan_odeme_sekilleri']:
            summary_data.append({
                'Firma': item['firma'],
                'En_Cok_Kullanilan_Odeme': item['en_cok_kullanilan_odeme'],
                'En_Cok_Kullanilan_Odeme_Yuzdesi': round(item['en_cok_kullanilan_odeme_yuzdesi'], 2),
                'Nadir_Kullanilan_Odeme': payment_info['odeme'],
                'Nadir_Kullanilan_Odeme_Sayisi': payment_info['sayi'],
                'Nadir_Kullanilan_Odeme_Yuzdesi': round(payment_info['yuzde'], 2),
                'Ozel_Ilgi': payment_info.get('ozel', False)
            })
    
    summary_df = pd.DataFrame(summary_data)
    
    # HTML rapor olu≈ütur
    html_report = _create_rarely_used_html_report(result_data, "√∂deme ≈üekli", firma_column)
    
    return {
        "status": "warning" if len(result_data) > 0 else "ok",
        "message": f"{len(result_data)} firmada nadiren kullanƒ±lan √∂deme ≈üekli tespit edildi" if result_data else "Nadiren kullanƒ±lan √∂deme ≈üekli tespit edilmedi",
        "data": result_df,
        "summary": summary_df,
        "html_report": html_report
    }

# ƒ∞ngilizce fonksiyon isimlerini T√ºrk√ße isimlerle uyumlu hale getirmek i√ßin takma adlar (alias)
check_rarely_used_origin_country = kontrol_nadir_kullanilan_mense_ulke
check_rarely_used_payment_method = kontrol_nadir_kullanilan_odeme_sekli 